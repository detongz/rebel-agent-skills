name: Deploy MySkills to Production (Docker)

on:
  push:
    branches:
      - feat/moltiverse-openclaw
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "üî® Building Docker image..."
          docker build -t myskills:latest -f frontend/Dockerfile frontend
          docker tag myskills:latest myskills:${{ github.sha }}

      - name: Deploy to server
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          set -e  # Exit on any error
          echo "üöÄ Deploying to server..."

          # Validate secrets are set
          if [ -z "$DEPLOY_KEY" ]; then
            echo "‚ùå Error: DEPLOY_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "$DEPLOY_HOST" ]; then
            echo "‚ùå Error: DEPLOY_HOST secret is not set"
            exit 1
          fi

          # Setup SSH with improved key format handling
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write the SSH key and validate format
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Validate SSH key format
          echo "Validating SSH key format..."
          if ! ssh-keygen -l -f ~/.ssh/deploy_key >/dev/null 2>&1; then
            echo "‚ùå Error: Invalid SSH key format"
            echo "The SSH key may be corrupted or in an unsupported format"
            echo "Please ensure the key is in PEM format (RSA)"
            exit 1
          fi
          echo "‚úÖ SSH key format is valid"

          # Disable SSH strict host key checking for this deployment
          cat > ~/.ssh/config << 'EOF'
          Host *
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
              ConnectTimeout 30
              ServerAliveInterval 60
              ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config

          # Add server to known hosts (with timeout and retry)
          echo "Adding server to known hosts..."
          timeout 30 ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è Warning: ssh-keyscan failed, continuing anyway..."
          }

          # Test SSH connection first with verbose output
          echo "Testing SSH connection..."
          SSH_OUTPUT=$(timeout 30 ssh -v -i ~/.ssh/deploy_key root@$DEPLOY_HOST "echo 'Connection successful'" 2>&1) || {
            echo "‚ùå Error: Cannot connect to server via SSH"
            echo "SSH debug output:"
            echo "$SSH_OUTPUT"
            echo ""
            echo "Please check:"
            echo "  1. DEPLOY_SSH_KEY secret is correct and in PEM format"
            echo "  2. DEPLOY_HOST secret is correct and reachable"
            echo "  3. SSH key is authorized on the server"
            echo "  4. Server allows SSH connections from GitHub Actions IPs"
            exit 1
          }
          echo "‚úÖ SSH connection successful"

          # Save Docker image and transfer to server
          echo "üì¶ Transferring Docker image to server..."
          IMAGE_SIZE=$(docker images myskills:latest --format "{{.Size}}")
          echo "Image size: $IMAGE_SIZE"

          # Transfer with better error handling and progress indication
          echo "Starting image transfer (this may take a few minutes)..."
          if ! docker save myskills:latest | \
             timeout 600 ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \
             -i ~/.ssh/deploy_key root@$DEPLOY_HOST "docker load" 2>&1; then
            echo "‚ùå Error: Failed to transfer Docker image"
            echo "This could be due to:"
            echo "  - Network timeout (image too large)"
            echo "  - Insufficient disk space on server"
            echo "  - SSH connection instability"
            echo ""
            echo "Current image size: $IMAGE_SIZE"
            echo ""
            echo "Troubleshooting tips:"
            echo "  1. Check server disk space: ssh root@$DEPLOY_HOST 'df -h'"
            echo "  2. Check Docker is running: ssh root@$DEPLOY_HOST 'docker ps'"
            exit 1
          fi
          echo "‚úÖ Docker image transferred successfully"

          # Deploy container on server
          echo "Starting container on server..."
          if ! ssh -i ~/.ssh/deploy_key root@$DEPLOY_HOST "bash -s" << 'EOF'
          set -e
          echo "Server: Checking Docker availability..."
          docker --version

          echo "Server: Stopping and removing old container..."
          docker stop myskills 2>/dev/null || echo "No existing container to stop"
          docker rm myskills 2>/dev/null || echo "No existing container to remove"

          echo "Server: Starting new container..."
          docker run -d \
            --name myskills \
            --restart unless-stopped \
            -p 3000:3000 \
            -e NODE_ENV=production \
            -e PORT=3000 \
            -e HOSTNAME=0.0.0.0 \
            --health-cmd="curl -f http://localhost:3000/ || exit 1" \
            --health-interval=30s \
            --health-timeout=10s \
            --health-retries=3 \
            myskills:latest

          echo "Server: Container started, waiting for health check..."
          sleep 5

          echo "Server: Verifying container status..."
          docker ps --filter "name=myskills" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

          echo "Server: Checking container logs..."
          docker logs --tail 20 myskills || echo "Warning: Could not retrieve container logs"

          echo "Server: Cleaning up old images..."
          docker image prune -f

          echo "Server: Container deployed successfully!"
          EOF
          then
            echo "Error: Container deployment failed"
            exit 1
          fi

          # Cleanup
          rm -f ~/.ssh/deploy_key

          echo "‚úÖ Deployment completed successfully!"

      - name: Health check
        if: always()
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          if [ -n "$DEPLOY_URL" ]; then
            echo "üè• Running health check..."
            sleep 10
            curl -f "$DEPLOY_URL" || echo "Health check failed"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "================================"
          echo "üéâ Deployment Summary"
          echo "================================"
          echo ""
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üîó Commit: ${{ github.sha }}"
          echo "üê≥ Image: myskills:latest"
          echo ""
          echo "Server: ${{ secrets.DEPLOY_HOST }}"
          echo "URL: ${{ secrets.DEPLOY_URL || 'Not configured' }}"
