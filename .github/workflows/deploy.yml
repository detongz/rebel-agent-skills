name: Deploy MySkills to Production

on:
  push:
    branches:
      - feat/moltiverse-openclaw
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install build tools for native modules
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 make g++ build-essential

      - name: Cache root node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Cache frontend node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-frontend-node-modules-${{ hashFiles('frontend/package-lock.json', 'frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-node-modules-

      - name: Install dependencies
        run: |
          npm ci
          cd packages/shared && npm install

      - name: Install frontend dependencies
        run: |
          cd frontend && npm install

      - name: Build packages
        run: |
          echo "ğŸ”¨ Building shared package..."
          cd packages/shared && npm run build

          echo "ğŸ”¨ Building frontend..."
          cd ../../frontend && npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          TURBOPACK_ROOT: ${{ github.workspace }}/frontend

      - name: Deploy to server
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          echo "ğŸš€ Deploying to server..."

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null

          SSH_CMD="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@$DEPLOY_HOST"

          # Stop PM2 on server
          echo "Stopping PM2..."
          $SSH_CMD "pm2 stop myskills-frontend 2>/dev/null || true"

          # Clear old build on server
          echo "Cleaning old build..."
          $SSH_CMD "cd /var/www/myskills && rm -rf .next"

          # Copy .next build directory from local to server
          echo "Copying .next directory..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r frontend/.next/* root@$DEPLOY_HOST:/var/www/myskills/.next/

          # Copy public assets
          echo "Copying public assets..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r frontend/public/* root@$DEPLOY_HOST:/var/www/myskills/public/ 2>/dev/null || true

          # Restart PM2
          echo "Restarting PM2..."
          $SSH_CMD "cd /var/www/myskills && pm2 restart myskills-frontend 2>/dev/null || pm2 start npm --name myskills-frontend -- start"

          # Cleanup
          rm -f ~/.ssh/deploy_key

          echo "âœ… Deployment completed successfully!"

      - name: Cleanup
        if: always()
        run: rm -rf deploy-temp

      - name: Health check
        if: always()
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          if [ -n "$DEPLOY_URL" ]; then
            echo "ğŸ¥ Running health check..."
            sleep 10

            # æ£€æŸ¥ API ç«¯ç‚¹
            curl -f "$DEPLOY_URL/api/health" || echo "API health check failed"

            # æ£€æŸ¥å‰ç«¯
            curl -f "$DEPLOY_URL" || echo "Frontend health check failed"

            echo "âœ… Deployment health check completed"
          else
            echo "âš ï¸  No DEPLOY_URL configured, skipping health check"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "================================"
          echo "ğŸ‰ Deployment Summary"
          echo "================================"
          echo ""
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "â° Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "Deployed components:"
          echo "  âœ“ @myskills/shared"
          echo "  âœ“ frontend"
          echo "  âœ“ CLI"
          echo ""
          echo "ğŸŒ URLs to check:"
          echo "  - Main site: ${{ secrets.DEPLOY_URL || 'Not configured' }}"
          echo "  - Health check: ${{ secrets.DEPLOY_URL }}/api/health"
