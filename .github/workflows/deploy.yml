name: Deploy MySkills to Production

on:
  push:
    branches:
      - feat/moltiverse-openclaw
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶ÂèëÈÉ®ÁΩ≤

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install build tools for native modules
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 make g++

      - name: Cache root node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Cache frontend node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-frontend-node-modules-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-node-modules-

      - name: Install dependencies
        run: |
          npm ci
          cd packages/shared && npm install

      - name: Install frontend dependencies
        run: |
          cd frontend && npm install --force

      - name: Build packages
        run: |
          echo "üî® Building shared package..."
          cd packages/shared && npm run build

          echo "üî® Building frontend..."
          cd ../../frontend && npm run build

      - name: Deploy to server
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "üöÄ Deploying to server..."

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null

          # Stop PM2
          ssh -i ~/.ssh/deploy_key root@$DEPLOY_HOST "pm2 stop myskills-frontend || true"

          # Sync .next build directory
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            frontend/.next/ root@$DEPLOY_HOST:$DEPLOY_PATH/.next/

          # Sync public assets
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            frontend/public/ root@$DEPLOY_HOST:$DEPLOY_PATH/public/

          # Sync package files
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            frontend/package.json frontend/package-lock.json frontend/next.config.ts \
            root@$DEPLOY_HOST:$DEPLOY_PATH/

          # Restart PM2
          ssh -i ~/.ssh/deploy_key root@$DEPLOY_HOST "cd $DEPLOY_PATH && pm2 restart myskills-frontend"

          # Cleanup
          rm -f ~/.ssh/deploy_key

          echo "‚úÖ Deployment completed successfully!"

      - name: Cleanup
        if: always()
        run: rm -rf deploy-temp

      - name: Health check
        if: always()
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          if [ -n "$DEPLOY_URL" ]; then
            echo "üè• Running health check..."
            sleep 10

            # Ê£ÄÊü• API Á´ØÁÇπ
            curl -f "$DEPLOY_URL/api/health" || echo "API health check failed"

            # Ê£ÄÊü•ÂâçÁ´Ø
            curl -f "$DEPLOY_URL" || echo "Frontend health check failed"

            echo "‚úÖ Deployment health check completed"
          else
            echo "‚ö†Ô∏è  No DEPLOY_URL configured, skipping health check"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "================================"
          echo "üéâ Deployment Summary"
          echo "================================"
          echo ""
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üîó Commit: ${{ github.sha }}"
          echo "‚è∞ Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "Deployed components:"
          echo "  ‚úì @myskills/shared"
          echo "  ‚úì frontend"
          echo "  ‚úì CLI"
          echo ""
          echo "üåê URLs to check:"
          echo "  - Main site: ${{ secrets.DEPLOY_URL || 'Not configured' }}"
          echo "  - Health check: ${{ secrets.DEPLOY_URL }}/api/health"
