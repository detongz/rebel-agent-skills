name: Deploy MySkills to Production (Docker)

on:
  push:
    branches:
      - feat/moltiverse-openclaw
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "üî® Building Docker image..."
          docker build -t myskills:latest -f frontend/Dockerfile frontend
          docker tag myskills:latest myskills:${{ github.sha }}

      - name: Deploy to server
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          set -e  # Exit on any error
          echo "üöÄ Deploying to server..."

          # Validate secrets are set
          if [ -z "$DEPLOY_KEY" ]; then
            echo "‚ùå Error: DEPLOY_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "$DEPLOY_HOST" ]; then
            echo "‚ùå Error: DEPLOY_HOST secret is not set"
            exit 1
          fi

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Add server to known hosts (with timeout and retry)
          echo "Adding server to known hosts..."
          timeout 30 ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è Warning: ssh-keyscan failed, continuing anyway..."
          }

          # Test SSH connection first
          echo "Testing SSH connection..."
          if ! timeout 30 ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes root@$DEPLOY_HOST "echo 'Connection successful'" 2>&1; then
            echo "‚ùå Error: Cannot connect to server via SSH"
            echo "Please check:"
            echo "  1. DEPLOY_SSH_KEY secret is correct"
            echo "  2. DEPLOY_HOST secret is correct and reachable"
            echo "  3. SSH key is authorized on the server"
            exit 1
          fi

          # Save Docker image and transfer to server
          echo "Transferring Docker image..."
          if ! docker save myskills:latest | timeout 300 ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 root@$DEPLOY_HOST "docker load" 2>&1; then
            echo "‚ùå Error: Failed to transfer Docker image"
            exit 1
          fi

          # Deploy container on server
          echo "Starting container..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 root@$DEPLOY_HOST bash -x << 'ENDSSH'
            set -e
            # Stop and remove old container
            docker stop myskills 2>/dev/null || true
            docker rm myskills 2>/dev/null || true

            # Run new container
            docker run -d \
              --name myskills \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              myskills:latest

            # Clean up old images
            docker image prune -f

            echo "Container started!"
            docker ps --filter "name=myskills" --format "table {{.Names}}\t{{.Status}}" || echo "Warning: Container not found in ps output"
          ENDSSH

          # Cleanup
          rm -f ~/.ssh/deploy_key

          echo "‚úÖ Deployment completed successfully!"

      - name: Health check
        if: always()
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          if [ -n "$DEPLOY_URL" ]; then
            echo "üè• Running health check..."
            sleep 10
            curl -f "$DEPLOY_URL" || echo "Health check failed"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "================================"
          echo "üéâ Deployment Summary"
          echo "================================"
          echo ""
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üîó Commit: ${{ github.sha }}"
          echo "üê≥ Image: myskills:latest"
          echo ""
          echo "Server: ${{ secrets.DEPLOY_HOST }}"
          echo "URL: ${{ secrets.DEPLOY_URL || 'Not configured' }}"
