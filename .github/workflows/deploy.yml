name: Deploy MySkills to Production (Docker)

on:
  push:
    branches:
      - feat/moltiverse-openclaw
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "üî® Building Docker image..."
          docker build -t myskills:latest -f frontend/Dockerfile .
          docker tag myskills:latest myskills:${{ github.sha }}

      - name: Deploy to server
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          echo "üöÄ Deploying to server..."

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null

          # Save Docker image and transfer to server
          echo "Transferring Docker image..."
          docker save myskills:latest | gzip | ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@$DEPLOY_HOST "docker load"

          # Deploy container on server
          echo "Starting container..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@$DEPLOY_HOST bash << 'ENDSSH'
            # Stop and remove old container
            docker stop myskills 2>/dev/null || true
            docker rm myskills 2>/dev/null || true

            # Run new container
            docker run -d \
              --name myskills \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              myskills:latest

            # Clean up old images
            docker image prune -f

            echo "Container started!"
            docker ps | grep myskills
          ENDSSH

          # Cleanup
          rm -f ~/.ssh/deploy_key

          echo "‚úÖ Deployment completed successfully!"

      - name: Health check
        if: always()
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          if [ -n "$DEPLOY_URL" ]; then
            echo "üè• Running health check..."
            sleep 10
            curl -f "$DEPLOY_URL" || echo "Health check failed"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "================================"
          echo "üéâ Deployment Summary"
          echo "================================"
          echo ""
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üîó Commit: ${{ github.sha }}"
          echo "üê≥ Image: myskills:latest"
          echo ""
          echo "Server: ${{ secrets.DEPLOY_HOST }}"
          echo "URL: ${{ secrets.DEPLOY_URL || 'Not configured' }}"
