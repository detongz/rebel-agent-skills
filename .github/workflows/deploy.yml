name: Deploy MySkills to Production

on:
  push:
    branches:
      - feat/moltiverse-openclaw
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install build tools for native modules
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 make g++

      - name: Cache root node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Cache frontend node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-frontend-node-modules-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-node-modules-

      - name: Install dependencies
        run: |
          npm ci
          cd packages/shared && npm install

      - name: Install frontend dependencies
        run: |
          cd frontend && npm ci --legacy-peer-deps

      - name: Build packages
        run: |
          echo "ğŸ”¨ Building shared package..."
          cd packages/shared && npm run build

          echo "ğŸ”¨ Building frontend..."
          cd ../../frontend && npm run build

      - name: Deploy to server
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "ğŸš€ Starting deployment..."

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p deploy-temp

          # å¤åˆ¶æ„å»ºæ–‡ä»¶
          cp -r packages/shared/dist deploy-temp/shared
          cp -r frontend/dist deploy-temp/frontend
          cp -r packages/cli/dist deploy-temp/cli

          # ä¸Šä¼ åˆ°æœåŠ¡å™¨
          echo "Uploading files to server..."

          # ä½¿ç”¨ rsync åŒæ­¥æ–‡ä»¶ï¼ˆå¦‚æœ DEPLOY_HOST æ˜¯æœåŠ¡å™¨åœ°å€ï¼‰
          # æˆ–è€…ä½¿ç”¨ scp å¤åˆ¶æ–‡ä»¶

          if [ -n "$DEPLOY_HOST" ]; then
            # SSH æ–¹å¼éƒ¨ç½²
            echo "Deploying via SSH to $DEPLOY_HOST"

            # åˆ›å»ºä¸´æ—¶ SSH å¯†é’¥æ–‡ä»¶
            echo "$DEPLOY_KEY" > deploy_key.pem
            chmod 600 deploy_key.pem

            # éƒ¨ç½²å‘½ä»¤ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
            ssh -i deploy_key.pem -o StrictHostKeyChecking=no \
              "$DEPLOY_HOST" \
              "mkdir -p $DEPLOY_PATH && cd $DEPLOY_PATH && \
               rm -rf shared frontend cli old 2>/dev/null || true && \
               mkdir -p shared frontend cli && \
               tar -czf - | tar -xzf - -C $DEPLOY_PATH && \
               rsync -avz --delete deploy-temp/ $DEPLOY_HOST:$DEPLOY_PATH/"

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f deploy_key.pem
            rm -rf deploy-temp
          fi

      - name: Cleanup
        if: always()
        run: rm -rf deploy-temp

      - name: Health check
        if: always()
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          if [ -n "$DEPLOY_URL" ]; then
            echo "ğŸ¥ Running health check..."
            sleep 10

            # æ£€æŸ¥ API ç«¯ç‚¹
            curl -f "$DEPLOY_URL/api/health" || echo "API health check failed"

            # æ£€æŸ¥å‰ç«¯
            curl -f "$DEPLOY_URL" || echo "Frontend health check failed"

            echo "âœ… Deployment health check completed"
          else
            echo "âš ï¸  No DEPLOY_URL configured, skipping health check"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "================================"
          echo "ğŸ‰ Deployment Summary"
          echo "================================"
          echo ""
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "â° Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "Deployed components:"
          echo "  âœ“ @myskills/shared"
          echo "  âœ“ frontend"
          echo "  âœ“ CLI"
          echo ""
          echo "ğŸŒ URLs to check:"
          echo "  - Main site: ${{ secrets.DEPLOY_URL || 'Not configured' }}"
          echo "  - Health check: ${{ secrets.DEPLOY_URL }}/api/health"
